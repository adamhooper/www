#!/usr/bin/env script/runner

require 'hpricot'

doc = File.open(ARGV.first) do |f|
  Hpricot.XML(f)
end

def extract_text(doc, elem)
  doc.at(elem) ? doc.at(elem).inner_text : ''
end

title = extract_text(doc, 'title')
title = $1 if title =~ /^\xef\xbb\xbf(.*)/ # utf-8 header

author_ip = extract_text(doc, 'ipaddress')
author_ip = '127.0.0.1' if author_ip.blank?

author_name = extract_text(doc, 'author')
author_website = extract_text(doc, 'link')
author_email = extract_text(doc, 'email')
created_at = Time.at(doc.at('pubDate').inner_text.to_f).to_datetime
body = doc.at('description').inner_text

author_website = 'http://adamhooper.com' if author_website.blank? && author_email.blank?

post = Blog::Post::find_by_title(title)
post.comments.create!(
  :author_ip => author_ip,
  :author_name => author_name,
  :author_website => author_website,
  :author_email => author_email,
  :created_at => created_at,
  :body => body
)

puts "Created comment on #{post.title}"
